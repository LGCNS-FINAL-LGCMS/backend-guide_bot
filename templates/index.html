<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS 챗봇</title>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f0f2f5;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
    }

    .chat-container {
        width: 100%;
        max-width: 600px;
        background-color: white;
        border-radius: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 90vh; /* 화면 높이의 90% */
        max-height: 800px; /* 최대 높이 설정 */
    }

    .chat-header {
        background-color: #4f46e5; /* Indigo 600 */
        color: white;
        padding: 1rem 1.5rem;
        font-size: 1.25rem;
        font-weight: 600;
        border-top-left-radius: 1rem;
        border-top-right-radius: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chat-messages {
        flex-grow: 1;
        padding: 1.5rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background-color: #eef2f6; /* Gray 100 */
    }

    .message-bubble {
        max-width: 80%;
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        word-wrap: break-word;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .user-message {
        background-color: #4f46e5; /* Indigo 600 */
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 0.25rem;
    }

    .bot-message {
        background-color: #ffffff;
        color: #333;
        align-self: flex-start;
        border-bottom-left-radius: 0.25rem;
    }

    .loading-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #64748b; /* Slate 500 */
        font-style: italic;
        margin-top: 0.5rem;
    }

    .dot-pulse {
        width: 10px;
        height: 10px;
        background-color: #64748b;
        border-radius: 50%;
        animation: dot-pulse 1s infinite ease-in-out;
    }

    .dot-pulse:nth-child(2) {
        animation-delay: 0.2s;
    }

    .dot-pulse:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes dot-pulse {
        0%, 100% {
            transform: scale(0);
            opacity: 0.5;
        }
        50% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* 오류 메시지 스타일 추가 */
    .error-message {
        background-color: #fee2e2; /* Red 100 */
        color: #dc2626; /* Red 600 */
        border: 1px solid #ef4444; /* Red 500 */
    }

    .chat-input-area {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e2e8f0; /* Gray 200 */
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .chat-input {
        flex-grow: 1;
        padding: 0.75rem 1rem;
        border: 1px solid #cbd5e1; /* Gray 300 */
        border-radius: 0.75rem;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.2s;
    }

    .chat-input:focus {
        border-color: #4f46e5; /* Indigo 600 */
    }

    .send-button {
        background-color: #4f46e5; /* Indigo 600 */
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .send-button:hover {
        background-color: #4338ca; /* Indigo 700 */
    }

</style>
<body>
<div class="chat-container">
    <div class="chat-header">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2h2a1 1 0 000-2H9zm0 4a1 1 0 000 2h2a1 1 0 000-2H9z"
                  clip-rule="evenodd"></path>
        </svg>
        LMS 가이드 챗봇
    </div>
    <div class="chat-messages" id="chatMessages">
        <div class="message-bubble bot-message">안녕하세요! LMS 가이드 챗봇입니다. 무엇을 도와드릴까요?</div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="messageInput" class="chat-input" placeholder="질문을 입력하세요..." autocomplete="off">
        <button id="sendButton" class="send-button">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.169.409l5 1.429a1 1 0 001.169-1.409l-7-14z"></path>
            </svg>
            전송
        </button>
    </div>
</div>

<script>
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    let ws;
    let botMessageElement = null;
    let isStreaming = false; // 스트리밍 중인지 여부

    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const url = `${protocol}//${window.location.host}/ws`; // 웹소켓 엔드포인트 URL
        ws = new WebSocket(url);

        ws.onopen = (event) => {
            console.log('WebSocket connected:', event);
            appendMessage('system', '챗봇과 연결되었습니다.', 'system-message');
        };

        ws.onmessage = async (event) => {
            const message = event.data;

            // 1. 스트림 종료 신호 처리
            if (message === "__END_OF_STREAM__") {
                console.log("End of stream received.");
                isStreaming = false;
                removeLoadingIndicator();
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
                chatMessages.scrollTop = chatMessages.scrollHeight;
                //봇 메시지 버블을 완료 상태로 표시
                if (botMessageElement) {
                    botMessageElement.dataset.complete = 'true';
                }
                return;
            }

            try {
                // 2. JSON 메시지 파싱 시도
                const jsonResponse = JSON.parse(message);
                console.log("Received JSON:", jsonResponse);

                // 기존 스트리밍 메시지 버블이 있다면 완료 처리
                if (botMessageElement && botMessageElement.dataset.complete === 'false') {
                    botMessageElement.dataset.complete = 'true'; // 스트리밍 완료
                    removeLoadingIndicator();
                }

                if (jsonResponse.status === "OK") {
                    if (jsonResponse.data && jsonResponse.data.answer) {
                        const htmlContent = await marked.parse(jsonResponse.data.answer); // 마크다운 to HTML
                        if (botMessageElement && botMessageElement.dataset.complete === 'false') {
                            botMessageElement.innerHTML = htmlContent; // innerHTML 사용
                        } else {
                            botMessageElement = appendMessage('bot', htmlContent, 'bot-message', true); // HTML 콘텐츠임을 명시
                        }
                        botMessageElement.dataset.complete = 'true';
                    } else {
                        const htmlContent = await marked.parse(jsonResponse.message || "답변을 가져올 수 없습니다.");
                        botMessageElement = appendMessage('bot', htmlContent, 'bot-message', true);
                        botMessageElement.dataset.complete = 'true';
                    }
                } else if (jsonResponse.status === "ERROR") {
                    if (botMessageElement && botMessageElement.dataset.complete === 'false') {
                        botMessageElement.innerHTML = '';
                    }
                    const errorHtml = await marked.parse(jsonResponse.message || "알 수 없는 오류가 발생했습니다.");
                    const errorBubble = appendMessage('bot', errorHtml, 'bot-message error-message', true);
                    errorBubble.dataset.complete = 'true';
                }

                // JSON 메시지를 받으면 스트리밍이 완료된 것으로 간주하고 상태 초기화
                isStreaming = false;
                removeLoadingIndicator();
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
                chatMessages.scrollTop = chatMessages.scrollHeight;

            } catch (e) {
                // 3. JSON 파싱 실패 시 (텍스트 청크)
                if (!botMessageElement || botMessageElement.dataset.complete === 'true') {
                    // 새로운 봇 메시지 버블을 시작 (스트리밍 시작)
                    botMessageElement = appendMessage('bot', '', 'bot-message');
                    botMessageElement.dataset.complete = 'false'; // 스트리밍 중
                    addLoadingIndicator(); // 로딩 인디케이터 추가
                }
                // 현재 봇 메시지 버블에 텍스트 청크 추가
                const currentText = botMessageElement.innerText || ''; // 이미 렌더링된 텍스트
                const newRawText = currentText + message; // 새로 받은 청크를 붙임
                botMessageElement.innerHTML = await marked.parse(newRawText);

                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        };

        ws.onclose = (event) => {
            console.log('WebSocket disconnected:', event);
            isStreaming = false;
            removeLoadingIndicator();
            appendMessage('system', '챗봇 연결이 끊어졌습니다. 페이지를 새로고침하여 다시 연결해주세요.', 'system-message');
            messageInput.disabled = true;
            sendButton.disabled = true;
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            isStreaming = false;
            removeLoadingIndicator();
            appendMessage('system', '웹소켓 오류가 발생했습니다. 콘솔을 확인해주세요.', 'system-message');
        };
    }

    function appendMessage(sender, text, className) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message-bubble', className);
        messageDiv.textContent = text;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return messageDiv;
    }

    function addLoadingIndicator() {
        const existingLoading = document.getElementById('loadingIndicator');
        if (existingLoading) return;

        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingIndicator';
        loadingDiv.classList.add('loading-indicator');
        loadingDiv.innerHTML = `
                <div class="dot-pulse"></div>
                <div class="dot-pulse"></div>
                <div class="dot-pulse"></div>
                <span>생각 중...</span>
            `;
        chatMessages.appendChild(loadingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeLoadingIndicator() {
        const loadingDiv = document.getElementById('loadingIndicator');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    }

    sendButton.addEventListener('click', () => {
        sendMessage();
    });

    messageInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            sendMessage();
        }
    });

    function sendMessage() {
        const message = messageInput.value.trim();
        if (message && ws && ws.readyState === WebSocket.OPEN && !isStreaming) {
            appendMessage('user', message, 'user-message');
            ws.send(message);
            messageInput.value = '';
            isStreaming = true;
            messageInput.disabled = true;
            sendButton.disabled = true;
        } else if (isStreaming) {
            console.log("스트리밍 중에는 새로운 메시지를 보낼 수 없습니다.");
        } else {
            console.log("웹소켓 연결이 준비되지 않았거나 메시지가 비어 있습니다.");
        }
    }

    window.addEventListener('load', connectWebSocket);

</script>

</body>
</html>
